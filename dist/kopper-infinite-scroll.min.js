!function(a,b){"function"==typeof define&&define.amd?define(["jquery","underscore","bluebird"],function(c,d,e){return a.KopperInfiniteScroll=b(c,d,e)}):"object"==typeof exports?module.exports=b(require("jquery"),require("underscore"),require("bluebird")):a.KopperInfiniteScroll=b($,_,Promise)}(this,function(a,b,c){function d(a){this.view=a,this.lowestPage=1,this.highestPage=1,this.lock=!1}return d.prototype.attachScrollListener=function(){this.view.on("scroll",b.debounce(b.bind(this.testScrollPosition,this),300))},d.prototype.detachScrollListener=function(){this.view.off("scroll")},d.prototype.getActualHeight=function(){var b=0;return this.view.find(".paginated-page-container").each(function(){b+=a(this).height()}),b},d.prototype.isScrolledIntoView=function(a){var b=this.view.scrollTop(),c=b+this.view.outerHeight(),d=a.position().top+b,e=d+a.height();return e>=c&&d<=b||e>=b&&d<=b||d<=c&&e>=c||d>=b&&e<=c},d.prototype.testScrollPosition=function(){var a=this;if(this.lock===!1){this.lock=!0;var b,c=this.lowestPage>2?this.getPaginatedContainerId(this.lowestPage-1):null;if(null!==c&&(b=this.view.find("#"+c)),this.view.scrollTop()+this.view.outerHeight()>=this.getActualHeight())return console.log("get next collection page",this.highestPage+1),this.retrieveNextItems().finally(function(){a.lock=!1});if(b&&this.isScrolledIntoView(b)===!0)return console.log("get previous collection page",this.lowestPage-1),this.retrievePreviousItems().finally(function(){a.lock=!1});var d=1;for(b=this.view.find("#"+this.getPaginatedContainerId(d));this.isScrolledIntoView(b)===!1&&d<this.lowestPage;)d++,b=this.view.find("#"+this.getPaginatedContainerId(d));var e=function(){return console.log("loop to get previous collection pages"),a.retrievePreviousItems().then(function(){if(0===b.children().length)return e()})};return e().then(function(){a.lock=!1})}},d.prototype.retrieveNextItems=function(){var a=this;if(this.hasPage(this.highestPage+1)===!0){this.showLoader(),this.highestPage++;var b=this.highestPage>2?this.highestPage-2:null;return b&&(this.emptyPaginatedContainer(this.getPaginatedContainerId(b)),this.lowestPage=b+1),this.getPage(this.highestPage).then(function(b){return a.managePaginatedContainers(b)})}return c.reject("could not get next or there is no next collection page")},d.prototype.retrievePreviousItems=function(){var a=this;if(this.hasPage(this.lowestPage-1)===!0){this.showLoader(),this.lowestPage--;var b=this.lowestPage<this.getCurrentTotalPages()-1?this.lowestPage+2:null;return b&&(this.removePaginatedContainer(this.getPaginatedContainerId(b)),this.highestPage=b-1),this.getPage(this.lowestPage).then(function(b){return a.managePaginatedContainers(b)})}return c.reject("could not get previous or there is no previous collection page")},d.prototype.getPage=function(a){return c.resolve(this.getPaginatedCollection().getPage(a))},d.prototype.hasPage=function(a){var b=this.getPaginatedCollection();if(b&&a>0){if(a<=this.getCurrentTotalPages())return!0;if(b.links)return!!b.links[a]}return!1},d.prototype.getCurrentPage=function(){return this.getPaginatedCollection().state.currentPage},d.prototype.getCurrentTotalPages=function(){return this.getPaginatedCollection().state.totalPages},d.prototype.getPaginatedCollection=function(){console.log("getPaginatedCollection should be implemented")},d.prototype.getPaginatedContainerId=function(a){var b=this.getPaginationContainerPrefix();return(b?b+"-":"")+a+"-container"},d.prototype.getPaginationContainerPrefix=function(){return null},d.prototype.createPaginatedContainer=function(b){var c=a(document.createElement("div"));return c.attr("id",this.getPaginatedContainerId(b)),c.addClass("paginated-page-container"),c},d.prototype.emptyPaginatedContainer=function(a){var b=this.view.find("#"+a),c=b.height();b.css({height:c+"px"}),b.addClass("empty"),b.empty()},d.prototype.removePaginatedContainer=function(a){var b=this.view.find("#"+a);b.remove()},d.prototype.managePaginatedContainers=function(a,b){var c=this;b||(b=this.getPaginatedContainerId(this.getCurrentPage()));var d=!1,e=this.view.find("#"+b);e.length>0?(e.removeAttr("style"),e.removeClass("empty")):(d=!0,e=this.createPaginatedContainer(this.getCurrentPage())),c.populatePaginatedList(a,e,d)},d.prototype.populatePaginatedList=function(a,b,c){console.log("populatePaginatedList should be implmented")},d.prototype.clearPageCounts=function(){this.lowestPage=1,this.highestPage=1},d.prototype.showLoader=function(){},d});