!function(a,b){"function"==typeof define&&define.amd?define(["jquery","underscore","bluebird"],function(c,d,e){return a.KopperInfiniteScroll=b(c,d,e)}):"object"==typeof exports?module.exports=b(require("jquery"),require("underscore"),require("bluebird")):a.KopperInfiniteScroll=b($,_,Promise)}(this,function(a,b,c){function d(a){this.view=a,this.lock=!1,this.pageStart=1,this.clearPageCounts()}return d.prototype.clearPageCounts=function(){this.lowestPage=this.pageStart,this.highestPage=this.pageStart},d.prototype.attachScrollListener=function(){this.view.on("scroll",b.debounce(b.bind(this.testScrollPosition,this),300))},d.prototype.detachScrollListener=function(){this.view.off("scroll")},d.prototype.getActualHeight=function(){var b=0;return this.view.find(".paginated-page-container").each(function(){b+=a(this).height()}),b},d.prototype.isScrolledIntoView=function(a){var b=this.view.scrollTop(),c=b+this.view.outerHeight(),d=a.position().top+b,e=d+a.height();return e>=c&&d<=b||e>=b&&d<=b||d<=c&&e>=c||d>=b&&e<=c},d.prototype.testScrollPosition=function(){var a=this;if(this.lock===!1){if(this.lock=!0,this.view.scrollTop()+this.view.outerHeight()>=this.getActualHeight())return console.debug("get next collection page",this.highestPage+1),this.retrieveNextItems().finally(function(){a.lock=!1});for(var b=this.pageStart,d=this.view.find("#"+this.getPaginatedContainerId(b));this.isScrolledIntoView(d)===!1;)b++,d=this.view.find("#"+this.getPaginatedContainerId(b));var e=function(){return console.debug("loop to get previous collection pages",b,"the collection is getting",a.lowestPage-1),a.retrievePreviousItems().then(function(){if(0===d.children().length)return e()})};return b<this.lowestPage?e().finally(function(){a.lock=!1}):(console.debug("we already have page",b,"or it is not in the collection - the collection is on page",a.getCurrentPage()),this.lock=!1,c.resolve())}},d.prototype.retrieveNextItems=function(){var a=this;return this.hasPage(this.highestPage+1)===!0?(this.showLoader(),this.lowestPage<this.highestPage&&(this.emptyPaginatedContainer(this.getPaginatedContainerId(this.lowestPage)),this.lowestPage++),this.getPage(this.highestPage+1).then(function(b){return a.highestPage++,a.managePaginatedContainers(b||a.getPaginatedCollection())})):c.reject("could not get next or there is no next collection page")},d.prototype.retrievePreviousItems=function(){var a=this;return this.hasPage(this.lowestPage-1)===!0?(this.showLoader(),this.removePaginatedContainer(this.getPaginatedContainerId(this.highestPage)),this.highestPage=Math.max(this.pageStart,this.highestPage-1),this.getPage(this.lowestPage-1).then(function(b){return a.lowestPage=Math.max(a.pageStart,a.lowestPage-1),a.managePaginatedContainers(b||a.getPaginatedCollection())})):c.reject("could not get previous or there is no previous collection page")},d.prototype.getPage=function(a){return c.resolve(this.getPaginatedCollection().getPage(a))},d.prototype.hasPage=function(a){var b=this.getPaginatedCollection();if(b&&a>0){if(a<=this.getCurrentTotalPages())return!0;if(b.links)return!!b.links[a]}return!1},d.prototype.getCurrentPage=function(){return this.getPaginatedCollection().state.currentPage},d.prototype.getCurrentTotalPages=function(){return this.getPaginatedCollection().state.totalPages},d.prototype.getPaginatedCollection=function(){console.error("getPaginatedCollection should be implemented")},d.prototype.getPaginatedContainerId=function(a){var b=this.getPaginationContainerPrefix();return(b?b+"-":"")+a+"-container"},d.prototype.getPaginationContainerPrefix=function(){return null},d.prototype.createPaginatedContainer=function(b){var c=a(document.createElement("div"));return c.attr("id",this.getPaginatedContainerId(b)),c.addClass("paginated-page-container"),c},d.prototype.emptyPaginatedContainer=function(a){var b=this.view.find("#"+a);if(b.length>0){var c=b.height();b.css({height:c+"px"}),b.addClass("empty"),b.empty()}},d.prototype.removePaginatedContainer=function(a){var b=this.view.find("#"+a);b.remove()},d.prototype.managePaginatedContainers=function(a,b){b||(b=this.getPaginatedContainerId(this.getCurrentPage()));var c=!1,d=this.view.find("#"+b);d.length>0?(d.removeAttr("style"),d.removeClass("empty")):(c=!0,d=this.createPaginatedContainer(this.getCurrentPage())),this.populatePaginatedList(a,d,c)},d.prototype.populatePaginatedList=function(a,b,c){console.error("populatePaginatedList should be implmented")},d.prototype.showLoader=function(){},d});